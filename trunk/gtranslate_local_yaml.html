<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <style>
        textarea{
            overflow:auto;
            height:99%;
            width:100%;
        }

        th{
            height:1;
        }

        table{
            height:80%;
            border: 3px solid blue;
        }

        td{
            width:50%;
        }

        .source{
            background-color: #FFE;
        }

        .result{
            background-color: #EFF;
        }

        .status{
            border: 3px solid orange;
            margin: 10px 0;
            padding: 5px;
        }
    </style>

    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    <script type="text/javascript" src="http://www.prototypejs.org/assets/2008/9/29/prototype-1.6.0.3.js"></script>
    <script type="text/javascript">

    google.load("language", "1");

    /**
     * source content object, living in global space so it can be accessed by callbacks
     */
    var sourceLines; // type: Array

    /**
     * a explict point for going through yaml
     */
    var currentLineNumber;

    /**
     * the text field for result output
     */
    var resultField;

    /**
     * an array of all place holder entries in the string current being translated
     */
    var placeHolderList;

    /**
     * init mark the system is ready
     */
    google.setOnLoadCallback(
        function(){
            updateStatus("Ready".bold());
            resultField = $("result_field");
            resultField.value = "";
            $("source_content").value = "";
        }
    );


    /**
     * update the sataus message
     *
     * @param msg [String] the status message to display
     */
    function updateStatus(msg)
    {
        $("status_node").update(msg);
    }

    /**
     * start the translation
     */
    function doTranslate()
    {
        // get the source content
        var source_content = $("source_content").value.strip();

        if(source_content == "")
        {
            reportFailure("missing source content");
            return;
        }

        sourceLines = source_content.split('\n');
        currentLineNumber= 0;

        translateLine();
        
        updateStatus("Translating...".bold().fontcolor("green").blink());

        return false;
    }

    /**
     * translate the yaml line by line
     */
    function translateLine()
    {
        // reach end?
        if(currentLineNumber >= sourceLines.length)
        {
            updateStatus("Translation completed".bold());
            return
        }

        // get the current line content
        var currentLine = sourceLines[currentLineNumber++];

        // is this a valid key:value line
        if(currentLine.indexOf(':') == -1)
        {
            addTranslatedResult(currentLine);
            translateLine();
            return;
        }

        // is this a valid key:value line, again
        var strippedLine = currentLine.strip();
        if(strippedLine.lastIndexOf(':') == strippedLine.length -1)
        {
            addTranslatedResult(currentLine);
            translateLine();
            return;
        }

        // translate this line
        currentLine.sub(/\s+(.*?)\:\s+\"(.*?)\"/,  function(match)
            {
                // get leading spaces
                var firstHalf = match[0].split(':')[0];
                var leadingSpaces = ' '.times(firstHalf.lastIndexOf(' ') + 1);
                addTranslatedResult(leadingSpaces+match[1]+':"');
                gTranslate(match[2]);
                return '';
            }
        )
    }

    /**
     * add translated line into the result field
     *
     * @param content [String]
     */
    function addTranslatedResult(content)
    {
        resultField.value += "\n"+ content;
    }

    function padTranslatedResult(content)
    {

        if(placeHolderList.length > 0)
        {
            var count = 0;
            content.gsub('（ （ ） ）',function(match)
                {
                    return "{{"+placeHolderList[count++]+"}}"
                }
            );
            placeHolderList = [];
        }

        resultField.value += content + '"';

        translateLine(); 
    }


    /**
     * report failure message into the output field
     *
     * @param msg[String] failure message
     */
    function reportFailure(msg)
    {
        resultField.value = "ERROR!!!\n"+msg;
    }

    /**
     * wrap the google translator
     */
    function gTranslate(text)
    {
        // take out all place holder strings
        placeHolderList = [];
        text.scan(/\{\{(.*?)\}\}/, function(match){placeHolderList.push(match[1])})

        // debugger;
        // dir(placeHolderList);

        // call google translate service
        google.language.translate(text, "en", "zh-CN",  function(result)
        {
            var translated = document.getElementById("translation");
            if (result.translation) {
                padTranslatedResult(result.translation);
            }
            else
            {
                padTranslatedResult("ERROR! fail to translate this entry.");
            }
        });
    }

    /**
     * A poorly written yaml parser :)
     * It convert yaml to json first, and then parse the json string into a data object.
     * 
     * @param yaml (String) the yaml data string
     * 
     * @return (Object) 
     */
    function yaml2Objct(yaml)
    {
		// compact the string
		// source_content = source_content.gsub(/\"\n\s+/,'"; ');
		yaml = yaml.gsub(/\s+(.*?)\:\s+\"(.*?)\"\n/,'"#{1}":"#{2}", ');
        yaml = yaml.gsub(/\,\s+\n\s+/,'},\n  ');
        yaml = yaml.gsub(/\}\,\n\s+(.*?)\:/,'},\n  "#{1}":{');
        yaml = yaml.gsub(/\:\n\s+(.*?)\:/,':\n  "#{1}":{');
        yaml = yaml.gsub(/\:\n\s+/,':{\n  ');
        yaml = "{"+yaml+"}}}";

        // a bit pretty format without indention
        yaml = yaml.gsub('", "','", \n"').gsub('"},','"\n},').gsub('":{"','":{\n"');

        return yaml.evalJSON();
    }

/*
	function tempSet()
	{
		result_node.value = source_content;
	}

	function tempReset()
	{
		source_content = $("source_content").value.strip();
	}
*/

    </script>
  </head>
  <body>
    <div class="status">
        Status:
        <span id="status_node">Waiting for Google translate API...</span>
    </div>

<form action="js_translate">
<dir>
    Target language: 
    <input type="button" value="Translate" name="translate_btn" onclick="doTranslate()"/>
    
</dir>
<table border="0" cellspacing="0" cellpadding="10" width="100%">
    <thead>
        <tr>
            <th class="source">Source YAML Content:</th>
            <th class="result">Translation:</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td class="source">
                 <textarea id="source_content" name="source_content"  wrap="off">
        </textarea>
            </td>
            <td class="result">
		<textarea id="result_field" name="source_content"  wrap="off">
		</textarea>

            </td>
        </tr>
    </tbody>
</table>
</form>

  </body>
</html>
